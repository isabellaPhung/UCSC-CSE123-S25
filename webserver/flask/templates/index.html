<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Dashboard</title>
    
    <!-- LOGIN CHECK CODE -->
    <script>
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            // Store the current user ID for use throughout the page
            window.currentUserId = currentUser.id;

            // Add username display and logout button to the page
            const leftSection = document.querySelector('.left-section');

            const userPanel = document.createElement('div');
            userPanel.className = 'user-panel';
            userPanel.style.marginBottom = '20px';
            userPanel.style.display = 'flex';
            userPanel.style.justifyContent = 'space-between';
            userPanel.style.alignItems = 'center';
            userPanel.style.backgroundColor = '#f5f5f5';
            userPanel.style.padding = '10px';
            userPanel.style.borderRadius = '4px';

            const usernameDisplay = document.createElement('div');
            usernameDisplay.textContent = `Welcome, ${currentUser.username}`;
            usernameDisplay.style.fontWeight = 'bold';

            const logoutButton = document.createElement('button');
            logoutButton.textContent = 'Logout';
            logoutButton.style.backgroundColor = '#f44336';
            logoutButton.style.color = 'white';
            logoutButton.style.border = 'none';
            logoutButton.style.padding = '5px 10px';
            logoutButton.style.borderRadius = '4px';
            logoutButton.style.cursor = 'pointer';

            logoutButton.addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                fetch('https://localhost/token/remove', {
                    method: 'POST'
                })
                .then(response => {
                    window.location.href = 'login';
                });
            });

            userPanel.appendChild(usernameDisplay);
            userPanel.appendChild(logoutButton);

            // Insert user panel at the top of the left section
            leftSection.insertBefore(userPanel, leftSection.firstChild);
        });
    </script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }
        
        .left-section {
            width: 25%;
            border-right: 1px solid #ccc;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .middle-section {
            width: 50%;
            border-right: 1px solid #ccc;
            padding: 20px;
        }
        
        .right-section {
            width: 25%;
            padding: 20px;
        }
        
        .date-time {
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .habits {
            margin-bottom: 30px;
        }
        
        h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .habit-list {
            min-height: 100px;
        }
        
        .deadlines-section {
            display: flex;
            flex-direction: column;
        }
        
        .header-with-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .controls {
            display: flex;
            gap: 5px;
        }
        
        .control-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background: #f5f5f5;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        
        .control-btn:hover {
            background: #e0e0e0;
        }
        
        .deadlines-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .deadlines-header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tasks-container {
            display: flex;
        }
        
        .tasks-list {
            flex: 1;
        }
        
        .assigned-times {
            flex: 1;
            text-align: right;
        }
        
        .task-row {
            padding: 8px 0;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .time-row {
            padding: 8px 0;
            margin-bottom: 5px;
            text-align: right;
            color: #555;
        }
        
        .task-row:hover {
            background-color: #f0f0f0;
        }
        
        .habits-link {
            color: #0066cc;
            text-decoration: none;
            font-weight: bold;
        }
        
        .habits-link:hover {
            text-decoration: underline;
        }
        
        .editable-input {
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 5px;
            width: 90%;
            font-family: inherit;
            font-size: inherit;
        }
        
        .habit-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            margin-bottom: 5px;
        }
        
        .habit-checkbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .habit-text {
            flex-grow: 1;
            cursor: pointer;
        }
        
        .habit-text:hover {
            background-color: #f0f0f0;
        }
        
        .events-container {
            display: flex;
            margin-bottom: 10px;
        }
        
        .event-name {
            flex-grow: 1;
            cursor: pointer;
            padding: 5px 0;
        }
        
        .event-name:hover {
            background-color: #f0f0f0;
        }
        
        .event-time {
            width: 90px;
            text-align: right;
            cursor: pointer;
            padding: 5px 0;
        }
        
        .event-time:hover {
            background-color: #f0f0f0;
        }
        
        .event-headers {
            display: flex;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .event-header-name {
            flex-grow: 1;
        }
        
        .event-header-time {
            width: 90px;
            text-align: right;
        }
        
        .task-details {
            display: none;
            padding: 10px;
            margin-top: 5px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .task-details-visible {
            display: block;
        }
        
        .task-description {
            margin-bottom: 10px;
        }
        
        .task-due-date {
            color: #666;
            font-size: 0.9em;
        }
        
        .task-timestamp {
            color: #888;
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .task-item:hover {
            background-color: #f5f5f5;
        }
        
        .task-name {
            font-weight: bold;
        }
        
        .no-tasks-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        .current-date-display {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2em;
            text-align: center;
        }
        
        .calendar-link {
            background-color: #2196F3;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
        }
        
        /* ADDED STYLES FOR EVENT DETAILS */
        .event-details {
            display: none;
            padding: 10px;
            margin-top: 5px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        
        .event-details-visible {
            display: block;
        }
        
        .event-timestamp {
            color: #888;
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        /* NEW STYLES FOR SCHEDULED HABITS AND EVENTS WITH DURATION */
        .scheduled-habit {
            background-color: #e6f7ff;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
        }

        .event-duration {
            color: #555;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .event-end-time {
            color: #555;
            font-size: 0.9em;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <!-- Left Section - 1/4 width -->
    <div class="left-section">
        <div class="date-time">
            <h2>Date & Time</h2>
            <div id="current-date-time"></div>
        </div>
        
        <div class="habits">
            <h2><a href="{{ url_for('habits') }}" class="habits-link">Habits</a></h2>
            <div class="habit-list" id="main-habits-list">
                <!-- Habits will be dynamically loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Middle Section - 2/4 width -->
    <div class="middle-section">
        <div class="deadlines-section">
            <div class="deadlines-header">
                <div class="section-title">
                    <h1>Today's Tasks</h1>
                    <div class="controls">
                        <a href="{{ url_for('calendar') }}" class="calendar-link">Calendar</a>
                        <button class="control-btn add-task" id="add-task-btn" title="Add Task">+</button>
                        <button class="control-btn remove-task" title="Remove Task">-</button>
                    </div>
                </div>
            </div>
            
            <div class="current-date-display" id="current-date-display"></div>
            
            <div id="today-tasks-container">
                <!-- Today's tasks will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Right Section - 1/4 width -->
    <div class="right-section">
        <div class="event-section">
            <div class="header-with-controls">
                <h2><a href="{{ url_for('events') }}" class="events-link">Event</a></h2>
                <div class="controls">
                    <button class="control-btn add-event">+</button>
                    <button class="control-btn remove-event">-</button>
                </div>
            </div>
            <div class="event-headers">
                <div class="event-header-name">Event Name</div>
                <div class="event-header-time">Time</div>
            </div>
            <div id="events">
                <!-- Events will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const dayStart = new Date();
        dayStart.setHours(0, 0, 0, 0);
        const startTimestamp = Math.floor(dayStart.getTime() / 1000);

        const dayEnd = new Date();
        dayEnd.setHours(23, 59, 59, 999);
        const endTimestamp = Math.floor(dayEnd.getTime() / 1000);

        // Day mapping: 0 = Monday, 1 = Tuesday, 2 = Wednesday, 3 = Thursday,
        // 4 = Friday, 5 = Saturday, 6 = Sunday

        // Get current day of the week (0-6 where 0 is Sunday)
        const today = new Date();
        const todayStr = today.toISOString("%Y-%m-%d").split("T")[0];
        const currentDayIndex = today.getDay();
        // Convert to our display order (0 = Monday, ... 6 = Sunday)
        const adjustedDayIndex = currentDayIndex === 0 ? 6 : currentDayIndex - 1;
        // Convert to our flag order (0 = Saturday, ... 6 = Sunday)
        const flagDayIndex = 6 - currentDayIndex;

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const dateTimeElement = document.getElementById('current-date-time');
            dateTimeElement.textContent = now.toLocaleString();
            
            // Update today's date display
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date-display').textContent = now.toLocaleDateString(undefined, options);
        }
        
        // Update every second
        setInterval(updateDateTime, 1000);
        updateDateTime(); // Initial call
        
        // COMPLETELY REPLACED FUNCTION: LOAD HABITS WITH SCHEDULED DAYS SUPPORT
        function loadHabits() {
            const habitsList = document.getElementById('main-habits-list');
            habitsList.innerHTML = '';

            fetch('https://localhost/api/today_habits', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({today: todayStr})
            })
            .then(response => {
                if (!response.ok) {
                    console.error("Failed to get habits");
                }
                return response.json()
            })
            .then(data => {
                const habits = data.habit;
            
                habits.forEach((habit, index) => {
                    // CHANGED: Only show habits that are scheduled for today
                    const isScheduledToday = habit.goal & Math.pow(2, flagDayIndex);

                    // Create habit item
                    const habitItem = document.createElement('div');
                    habitItem.className = 'habit-item';

                    // CHANGED: Add scheduled indicator (highlight) if this habit is scheduled for today
                    if (isScheduledToday) {
                        habitItem.classList.add('scheduled-habit');

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'habit-checkbox';
                        checkbox.checked = habit.days[adjustedDayIndex];
                        checkbox.dataset.habitIndex = index;

                        // Add change listener to update both the completed status and the day status
                        checkbox.addEventListener('change', function() {
                            updateHabitCompletion(habit.id, this.checked);
                        });

                        const habitText = document.createElement('div');
                        habitText.className = 'habit-text';
                        habitText.textContent = habit.name;

                        habitItem.appendChild(checkbox);
                        habitItem.appendChild(habitText);
                        habitsList.appendChild(habitItem);
                    }
                });

                // ADDED: If no habits are scheduled for today, show a message
                if (habitsList.children.length === 0) {
                    const noHabitsMsg = document.createElement('div');
                    noHabitsMsg.textContent = 'No habits scheduled for today.';
                    noHabitsMsg.style.color = '#666';
                    noHabitsMsg.style.fontStyle = 'italic';
                    noHabitsMsg.style.padding = '10px 0';
                    habitsList.appendChild(noHabitsMsg);
                }
            });
        }
        
        // REPLACED FUNCTION: UPDATE HABIT COMPLETION STATUS
        function updateHabitCompletion(habitId, completed) {
            // Send the habit to S3
            fetch('https://localhost/api/update_habit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({id: habitId, today: todayStr, completed: completed})
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Failed to update habit to S3');
                }
            })
            .catch(error => {
                console.error('Error updating habit to S3:', error);
            });

            // Give S3 a second to update
            setTimeout(() => {
                // Refresh the display to show the updated state
                loadHabits();
            }, "1000");
        }
        
        // Load today's tasks from S3
        function loadTodaysTasks() {
            const tasksContainer = document.getElementById('today-tasks-container');
            tasksContainer.innerHTML = '';

            fetch('https://localhost/api/today_tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({start: startTimestamp, end: endTimestamp})
                })
                .then(response => {
                    if (!response.ok) {
                        console.error("Failed to get tasks");
                    }
                    return response.json()
                })
                .then(data => {
                    const todaysTasks = data.task;
            
                // Check if there are any tasks for today
                if (todaysTasks.length === 0) {
                    const noTasksMsg = document.createElement('div');
                    noTasksMsg.className = 'no-tasks-message';
                    noTasksMsg.textContent = 'No tasks scheduled for today. Click the + button to add a task.';
                    tasksContainer.appendChild(noTasksMsg);
                    return;
                }

                // Display today's tasks
                todaysTasks.forEach((task, index) => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item';
                    taskItem.dataset.index = index;

                    const taskName = document.createElement('div');
                    taskName.className = 'task-name';
                    taskName.textContent = task.name;

                    const taskTime = document.createElement('div');
                    taskTime.className = 'task-time';
                    taskTime.textContent = task.displayTime;

                    taskItem.appendChild(taskName);
                    taskItem.appendChild(taskTime);

                    // Create task details section
                    const taskDetails = document.createElement('div');
                    taskDetails.className = 'task-details';

                    // Add description
                    const description = document.createElement('div');
                    description.className = 'task-description';
                    description.textContent = task.description || 'No description provided';
                    taskDetails.appendChild(description);

                    // Add due date/time
                    const dueDate = document.createElement('div');
                    dueDate.className = 'task-due-date';
                    dueDate.textContent = `Due: ${new Date(task.duedate * 1000).toLocaleString()}`;
                    taskDetails.appendChild(dueDate);

                    // Add timestamp
                    const timestamp = document.createElement('div');
                    timestamp.className = 'task-timestamp';
                    timestamp.textContent = `Unix Timestamp: ${task.duedate}`;
                    taskDetails.appendChild(timestamp);

                    // Toggle details visibility on click
                    taskItem.addEventListener('click', function() {
                        taskDetails.classList.toggle('task-details-visible');
                    });

                    // Append to task container
                    tasksContainer.appendChild(taskItem);
                    tasksContainer.appendChild(taskDetails);
                });
            });
        }
        
        // COMPLETELY REPLACED FUNCTION: LOAD EVENTS WITH DURATION SUPPORT
        function loadEvents() {
            // Format today's date as YYYY-MM-DD
            const today = new Date();
            const todayStr = formatDateString(today);
            
            const eventsList = document.getElementById('events');
            eventsList.innerHTML = '';

            fetch('https://localhost/api/today_events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({start: startTimestamp, end: endTimestamp})
                })
                .then(response => {
                    if (!response.ok) {
                        console.error("Failed to get events");
                    }
                    return response.json()
                })
                .then(data => {
                    const events = data.event;

                events.forEach(event => {
                    const eventContainer = document.createElement('div');
                    eventContainer.className = 'events-container';

                    const eventName = document.createElement('div');
                    eventName.className = 'event-name';
                    eventName.textContent = event.name;

                    const eventTime = document.createElement('div');
                    eventTime.className = 'event-time';
                    eventTime.textContent = unixToDate(event.starttime);;

                    eventContainer.appendChild(eventName);
                    eventContainer.appendChild(eventTime);

                    // CHANGED: Create event details section with more info
                    const details = document.createElement('div');
                    details.className = 'event-details';

                    // ADDED: Show duration if available
                    if (event.duration) {
                        const duration = document.createElement('div');
                        duration.className = 'event-duration';
                        duration.textContent = `Duration: ${formatDuration(event.duration)}`;
                        details.appendChild(duration);
                    }

                    // ADDED: Show end time if available
                    if (event.endTime) {
                        const endTime = document.createElement('div');
                        endTime.className = 'event-end-time';
                        endTime.textContent = `End: ${event.endTime}`;
                        details.appendChild(endTime);
                    }

                    // Add timestamp if available
                    if (event.timestamp) {
                        const timestamp = document.createElement('div');
                        timestamp.className = 'event-timestamp';
                        timestamp.textContent = `Unix Timestamp: ${event.timestamp}`;
                        details.appendChild(timestamp);
                    }

                    // Toggle details on click
                    eventContainer.addEventListener('click', function() {
                        details.classList.toggle('event-details-visible');
                    });

                    // Add elements to DOM
                    eventsList.appendChild(eventContainer);
                    eventsList.appendChild(details);
                });
            });
        }
        
        // ADDED HELPER FUNCTION: Format duration for display
        function formatDuration(duration) {
            const hours = Math.floor(duration / 3600);
            const minutes = Math.floor((duration % 3600) / 60);
            
            if (hours === 0) {
                return `${minutes} min`;
            } else if (minutes === 0) {
                return `${hours} hr${hours > 1 ? 's' : ''}`;
            } else {
                return `${hours} hr${hours > 1 ? 's' : ''} ${minutes} min`;
            }
        }
        
        // Format date as YYYY-MM-DD
        function formatDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Load habits, tasks, and events
            loadHabits();
            loadTodaysTasks();
            loadEvents();
        });
        
        // Task management - Redirect to add task page
        document.getElementById('add-task-btn').addEventListener('click', function() {
            window.location.href = 'add_task';
        });
        
        // Remove task functionality
        document.querySelector('.remove-task').addEventListener('click', function() {
            // Get user-specific tasks
            const allUserTasks = JSON.parse(localStorage.getItem('userTasks')) || {};
            const tasks = allUserTasks[window.currentUserId] || [];
            
            // Get today's date in YYYY-MM-DD format for filtering
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;
            
            // Find tasks from today
            const todaysTasks = tasks.filter(task => task.dueDate === todayStr);
            
            if (todaysTasks.length > 0) {
                // Find the index of the last task for today in the original array
                const lastTaskIndex = tasks.findIndex(task => 
                    task.timestamp === todaysTasks[todaysTasks.length - 1].timestamp &&
                    task.name === todaysTasks[todaysTasks.length - 1].name
                );
                
                if (lastTaskIndex !== -1) {
                    // Remove the task
                    tasks.splice(lastTaskIndex, 1);
                    
                    // Update user tasks
                    allUserTasks[window.currentUserId] = tasks;
                    localStorage.setItem('userTasks', JSON.stringify(allUserTasks));
                    
                    loadTodaysTasks(); // Refresh the display
                }
            }
        });
        
        // Event management
        document.querySelector('.add-event').addEventListener('click', function() {
            window.location.href = 'events';
        });
        
        // Remove event functionality
        document.querySelector('.remove-event').addEventListener('click', function() {
            // Get user-specific events
            const allUserEvents = JSON.parse(localStorage.getItem('userEvents')) || {};
            const userEvents = allUserEvents[window.currentUserId] || {};
            
            // Get today's date
            const today = new Date();
            const todayStr = formatDateString(today);
            
            // Get today's events
            const todayEvents = userEvents[todayStr] || [];
            
            if (todayEvents.length > 0) {
                // Remove the last event
                todayEvents.pop();
                
                // Update storage
                userEvents[todayStr] = todayEvents;
                allUserEvents[window.currentUserId] = userEvents;
                localStorage.setItem('userEvents', JSON.stringify(allUserEvents));
                
                // Refresh display
                loadEvents();
            }
        });
        
        // Helper function to check if two dates are the same day
        function isSameDay(timestamp1, timestamp2) {
            const date1 = new Date(timestamp1 * 1000);
            const date2 = new Date(timestamp2 * 1000);
            
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }
        
        // Helper function to format date for display
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }

        // Convert Unix timestamp to start time
        function unixToDate(unixTimestamp) {
            const startTime = new Date(unixTimestamp * 1000);
            hour = startTime.getHours().toString()
            minute = startTime.getMinutes().toString()
            return `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
        }
    </script>
</body>
</html>